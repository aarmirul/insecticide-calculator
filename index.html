<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malaysian Vector Control Insecticide Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal {
            display: none;
        }
        .modal.show {
            display: flex;
        }
        .lucide-icon {
            width: 1rem;
            height: 1rem;
            display: inline-block;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .lucide-icon-lg {
            width: 2rem;
            height: 2rem;
        }
        .lucide-icon-xl {
            width: 4rem;
            height: 4rem;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="max-w-6xl mx-auto p-6 bg-white">
        <!-- Header -->
        <div class="bg-green-600 text-white p-6 rounded-lg mb-6">
            <div class="flex items-center gap-3 mb-2">
                <svg class="lucide-icon-lg" viewBox="0 0 24 24">
                    <rect width="16" height="10" x="2" y="3" rx="2" ry="2"/>
                    <path d="m7 11 2-2-2-2"/>
                    <path d="M11 13h4"/>
                </svg>
                <h1 class="text-2xl font-bold">Kalkulator Dos Racun Serangga</h1>
            </div>
            <p class="text-green-100">Malaysian Vector Control Insecticide Dose Calculator</p>
            <p class="text-sm text-green-200 mt-2">
                Untuk kawalan vektor dengue / For dengue vector control operations
            </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Input Section -->
            <div class="bg-gray-50 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    <svg class="lucide-icon text-blue-500" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="m9 12 2 2 4-4"/>
                    </svg>
                    Maklumat Input / Input Information
                </h2>

                <div class="space-y-4">
                    <!-- Calculation Mode -->
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            <svg class="lucide-icon inline mr-1" viewBox="0 0 24 24">
                                <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                            Mod Kiraan / Calculation Mode
                        </label>
                        <select
                            id="calculation_mode"
                            class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                        >
                            <option value="standard">Standard (Manual Input)</option>
                            <option value="single_case">Kes Tunggal / Single Case (200m radius)</option>
                            <option value="outbreak">Wabak / Outbreak (400m radius)</option>
                        </select>
                        <div id="mode-description" class="mt-2 p-2 bg-yellow-50 rounded text-xs">
                            <strong>Standard:</strong> Masukkan data kawasan dan rumah secara manual
                        </div>
                    </div>

                    <!-- Equipment Type (for scenarios) -->
                    <div id="equipment-selection" style="display: none;">
                        <label class="block text-sm font-medium mb-2">
                            <svg class="lucide-icon inline mr-1" viewBox="0 0 24 24">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10,9 9,9 8,9"/>
                            </svg>
                            Jenis Peralatan / Equipment Type
                        </label>
                        <div id="equipment-options">
                            <!-- Will be populated based on scenario -->
                        </div>
                    </div>

                    <!-- Estimated Indoor Volume (for scenarios) -->
                    <div id="estimated-indoor-div" style="display: none;">
                        <label class="block text-sm font-medium mb-2">
                            <svg class="lucide-icon inline mr-1" viewBox="0 0 24 24">
                                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                <polyline points="9,22 9,12 15,12 15,22"/>
                            </svg>
                            Anggaran Isipadu Dalaman (m³) / Estimated Indoor Volume (m³)
                        </label>
                        <input
                            type="number"
                            step="0.1"
                            id="estimated_indoor_volume"
                            class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                            placeholder="Anggaran untuk persiapan / Estimate for preparation"
                        />
                        <p class="text-xs text-gray-600 mt-1">
                            *Isipadu sebenar akan diketahui semasa survey pagi / *Actual volume determined during morning survey
                        </p>
                    </div>
                    <!-- Standard Input Fields -->
                    <div id="standard-inputs">
                        <!-- Number of Houses -->
                        <div>
                            <label class="block text-sm font-medium mb-2">
                                <svg class="lucide-icon inline mr-1" viewBox="0 0 24 24">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="m22 21-3-3m0 0-3-3m3 3 3 3m-3-3-3 3"/>
                                </svg>
                                Bilangan Rumah / Number of Houses
                            </label>
                            <input
                                type="number"
                                id="bilangan_rumah"
                                class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                                placeholder="Contoh: 150"
                            />
                        </div>

                        <!-- House Volume -->
                        <div>
                            <label class="block text-sm font-medium mb-2">
                                <svg class="lucide-icon inline mr-1" viewBox="0 0 24 24">
                                    <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                    <polyline points="9,22 9,12 15,12 15,22"/>
                                </svg>
                                Isipadu Rumah (m³) / House Volume (m³)
                            </label>
                            <input
                                type="number"
                                step="0.1"
                                id="isipadu_rumah"
                                class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                                placeholder="Contoh: 200"
                            />
                        </div>

                        <!-- Area Coverage -->
                        <div>
                            <label class="block text-sm font-medium mb-2">
                                <svg class="lucide-icon inline mr-1" viewBox="0 0 24 24">
                                    <pin path="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/>
                                    <circle cx="12" cy="10" r="3"/>
                                </svg>
                                Keluasan Kawasan (hektar) / Area Coverage (hectares)
                            </label>
                            <input
                                type="number"
                                step="0.1"
                                id="keluasan_kawasan"
                                class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                                placeholder="Contoh: 5.5"
                            />
                        </div>
                    </div>

                    <!-- Insecticide Type -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium">
                                Jenis Racun / Insecticide Product
                            </label>
                            <div class="flex gap-2">
                                <button
                                    type="button"
                                    id="btn-add-product"
                                    class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 flex items-center gap-1"
                                >
                                    <svg class="w-3 h-3" viewBox="0 0 24 24">
                                        <path d="M5 12h14m-7-7v14"/>
                                    </svg>
                                    Tambah / Add
                                </button>
                                <button
                                    type="button"
                                    id="btn-manage-products"
                                    class="text-sm bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 flex items-center gap-1"
                                    style="display: none;"
                                >
                                    <svg class="w-3 h-3" viewBox="0 0 24 24">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                        <path d="m18.5 2.5 a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4Z"/>
                                    </svg>
                                    Urus / Manage
                                </button>
                            </div>
                        </div>
                        <select
                            id="insecticide_type"
                            class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                        >
                            <optgroup label="Organophosphate (Built-in)">
                                <option value="malathion_57ec">Malathion 57% EC</option>
                                <option value="malathion_generic">Malathion (Generic)</option>
                                <option value="pirimiphos_methyl">Pirimiphos-methyl 50% EC</option>
                                <option value="actelic_50ec">Actelic 50EC</option>
                                <option value="sumithion_50ec">Sumithion 50EC</option>
                                <option value="temephos_50ec">Temephos 50% EC (Larvicide)</option>
                            </optgroup>
                            <optgroup label="Synthetic Pyrethroid (Built-in)">
                                <option value="deltamethrin_25sc">Deltamethrin 2.5% SC</option>
                                <option value="cypermethrin_10ec">Cypermethrin 10% EC</option>
                                <option value="permethrin_25ec">Permethrin 25% EC</option>
                                <option value="aqua_kothrine">Aqua K-Othrine EW</option>
                                <option value="moskilla">Moskilla</option>
                            </optgroup>
                            <optgroup label="Multi-active Pyrethroid (Built-in)">
                                <option value="aqua_resigen">Aqua Resigen</option>
                                <option value="bioallethrin_piperonyl">Bioallethrin + PBO</option>
                            </optgroup>
                        </select>
                        <div id="product-info" class="mt-2 p-2 bg-blue-50 rounded text-xs"></div>
                        <div id="product-warnings" class="mt-1"></div>
                    </div>

                    <!-- Application Method -->
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            Kaedah Aplikasi / Application Method
                        </label>
                        <select
                            id="application_method"
                            class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                        >
                            <option value="fogging">Fogging (Pengasapan)</option>
                            <option value="spraying">Spraying (Penyemburan)</option>
                            <option value="larvicide">Larvicide (Kawalan Larva)</option>
                        </select>
                    </div>

                    <!-- Solvent Type -->
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            <svg class="lucide-icon inline mr-1" viewBox="0 0 24 24">
                                <path d="M7 19H4.815a1.83 1.83 0 0 1-1.57-.881 1.785 1.785 0 0 1-.004-1.784L7.196 9.5"/>
                                <path d="M11 19h8.203a1.83 1.83 0 0 0 1.556-.89 1.784 1.784 0 0 0 0-1.775l-1.226-2.12"/>
                                <path d="m14 16-3 3 3 3"/>
                                <path d="M8.293 13.596 7.196 9.5 3.1 10.598"/>
                                <path d="m9.344 5.811 1.093-1.892A1.83 1.83 0 0 1 11.985 3a1.784 1.784 0 0 1 1.546.888l3.943 6.843"/>
                                <path d="m13.378 9.633 4.096 1.098 1.097-4.096"/>
                            </svg>
                            Jenis Pelarut / Solvent Type
                        </label>
                        <select
                            id="solvent_type"
                            class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                        >
                            <option value="water">Air / Water Based</option>
                            <option value="oil">Minyak / Oil Based</option>
                        </select>
                        <div id="solvent-warnings" class="mt-1"></div>
                    </div>

                    <!-- Indoor/Outdoor -->
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            <svg class="lucide-icon inline mr-1" viewBox="0 0 24 24">
                                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                <polyline points="9,22 9,12 15,12 15,22"/>
                            </svg>
                            Lokasi Aplikasi / Application Location
                        </label>
                        <select
                            id="location_type"
                            class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500"
                        >
                            <option value="indoor">Dalaman / Indoor</option>
                            <option value="outdoor">Luaran / Outdoor</option>
                        </select>
                        <div id="location-warnings" class="mt-1"></div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-3 pt-4">
                        <button
                            id="btn-calculate"
                            class="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg hover:bg-green-700 transition-colors"
                        >
                            Kira / Calculate
                        </button>
                        <button
                            id="btn-reset"
                            class="flex-1 bg-gray-600 text-white py-3 px-6 rounded-lg hover:bg-gray-700 transition-colors"
                        >
                            Reset
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="bg-blue-50 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-4 text-blue-800">
                    Keputusan Kiraan / Calculation Results
                </h2>

                <div id="results-container" style="display: none;">
                    <!-- Results will be populated by JavaScript -->
                </div>

                <div id="no-results" class="text-center text-gray-500 py-8">
                    <svg class="lucide-icon-xl mx-auto mb-4 text-gray-300" viewBox="0 0 24 24">
                        <rect width="16" height="10" x="2" y="3" rx="2" ry="2"/>
                        <path d="m7 11 2-2-2-2"/>
                        <path d="M11 13h4"/>
                    </svg>
                    <p>Sila masukkan maklumat dan klik "Kira" untuk mendapat keputusan</p>
                    <p class="text-sm">Please enter information and click "Calculate" to get results</p>
                </div>
            </div>
        </div>

        <!-- Footer Information -->
        <div class="mt-6 bg-gray-100 p-4 rounded-lg">
            <h3 class="font-semibold mb-2">Nota Penting / Important Notes:</h3>
            <ul class="text-sm text-gray-700 space-y-1">
                <li>• Sentiasa rujuk label produk untuk arahan penggunaan yang tepat</li>
                <li>• Always refer to product labels for precise usage instructions</li>
                <li>• Patuhi garis panduan Kementerian Kesihatan Malaysia</li>
                <li>• Comply with Malaysian Ministry of Health guidelines</li>
                <li>• Gunakan alat perlindungan diri (PPE) yang sesuai</li>
                <li>• Use appropriate personal protective equipment (PPE)</li>
                <li>• <strong>Kiraan Moskilla berdasarkan spesifikasi ACM (Agricultural Chemicals M) Sdn Bhd</strong></li>
                <li>• <strong>Moskilla calculations based on ACM (Agricultural Chemicals M) Sdn Bhd specifications</strong></li>
            </ul>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="add-product-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-96 overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="modal-title" class="text-xl font-semibold">Tambah Produk Baru / Add New Product</h2>
                    <button id="btn-close-modal" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" viewBox="0 0 24 24">
                            <path d="m18 6-12 12M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Nama Produk / Product Name *</label>
                        <input
                            type="text"
                            id="new-name"
                            class="w-full p-2 border rounded"
                            placeholder="e.g., Custom Malathion 50% EC"
                        />
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Kelas Kimia / Chemical Class</label>
                        <select id="new-chemical-class" class="w-full p-2 border rounded">
                            <option value="Organophosphate">Organophosphate</option>
                            <option value="Synthetic Pyrethroid">Synthetic Pyrethroid</option>
                            <option value="Natural Pyrethroid">Natural Pyrethroid</option>
                            <option value="Carbamate">Carbamate</option>
                            <option value="Organochlorine">Organochlorine</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Bahan Aktif / Active Ingredient *</label>
                        <input
                            type="text"
                            id="new-active-ingredient"
                            class="w-full p-2 border rounded"
                            placeholder="e.g., Malathion"
                        />
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Kepekatan / Concentration</label>
                        <input
                            type="text"
                            id="new-concentration"
                            class="w-full p-2 border rounded"
                            placeholder="e.g., 50% EC"
                        />
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">No. PHE</label>
                        <input
                            type="text"
                            id="new-phe-number"
                            class="w-full p-2 border rounded"
                            placeholder="e.g., PHE/INS/999"
                        />
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Nama Produk Komersial (pisah dengan koma)</label>
                        <input
                            type="text"
                            id="new-common-products"
                            class="w-full p-2 border rounded"
                            placeholder="e.g., Product A, Product B"
                        />
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Pencairan Fogging (%)</label>
                        <input
                            type="number"
                            step="0.01"
                            id="new-fogging-dilution"
                            class="w-full p-2 border rounded"
                            placeholder="e.g., 0.5"
                        />
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Pencairan Spraying (%)</label>
                        <input
                            type="number"
                            step="0.01"
                            id="new-spraying-dilution"
                            class="w-full p-2 border rounded"
                            placeholder="e.g., 2.0"
                        />
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Kadar Aplikasi Fogging (L per 1000m³)</label>
                        <input
                            type="number"
                            step="0.1"
                            id="new-application-rate-fogging"
                            class="w-full p-2 border rounded"
                            placeholder="e.g., 1.0"
                        />
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Kadar Aplikasi Spraying (mL per m²)</label>
                        <input
                            type="number"
                            step="1"
                            id="new-application-rate-spraying"
                            class="w-full p-2 border rounded"
                            placeholder="e.g., 40"
                        />
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Kadar Larvicide (ppm)</label>
                        <input
                            type="number"
                            step="0.1"
                            id="new-larvicide-rate"
                            class="w-full p-2 border rounded"
                            placeholder="e.g., 1.0"
                        />
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Pelarut Sesuai (tahan Ctrl untuk pilih multiple)</label>
                        <select
                            id="new-compatible-solvents"
                            multiple
                            class="w-full p-2 border rounded"
                        >
                            <option value="water">Air / Water</option>
                            <option value="oil">Minyak / Oil</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Kosongkan untuk semua jenis pelarut</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">Lokasi Sesuai (tahan Ctrl untuk pilih multiple)</label>
                        <select
                            id="new-indoor-outdoor"
                            multiple
                            class="w-full p-2 border rounded"
                        >
                            <option value="indoor">Dalaman / Indoor</option>
                            <option value="outdoor">Luaran / Outdoor</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Kosongkan untuk semua lokasi</p>
                    </div>
                </div>

                <div class="mt-4">
                    <label class="block text-sm font-medium mb-1">Amaran Keselamatan (satu baris satu amaran)</label>
                    <textarea
                        id="new-safety-warnings"
                        class="w-full p-2 border rounded"
                        rows="3"
                        placeholder="Gunakan PPE yang lengkap&#10;Jangan aplikasi semasa berangin&#10;Cuci tangan selepas penggunaan"
                    ></textarea>
                </div>

                <div class="mt-4">
                    <label class="block text-sm font-medium mb-1">Amaran Alam Sekitar (satu baris satu amaran)</label>
                    <textarea
                        id="new-environmental-warnings"
                        class="w-full p-2 border rounded"
                        rows="2"
                        placeholder="Toksik kepada ikan&#10;Elakkan pencemaran sumber air"
                    ></textarea>
                </div>

                <div class="flex gap-3 mt-6">
                    <button
                        id="btn-save-product"
                        class="flex-1 bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 flex items-center justify-center gap-2"
                    >
                        <svg class="w-4 h-4" viewBox="0 0 24 24">
                            <path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/>
                        </svg>
                        <span id="save-button-text">Simpan / Save</span>
                    </button>
                    <button
                        id="btn-cancel-modal"
                        class="flex-1 bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-700"
                    >
                        Batal / Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Products Modal -->
    <div id="manage-products-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-96 overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Urus Produk Custom / Manage Custom Products</h2>
                    <button id="btn-close-manage-modal" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" viewBox="0 0 24 24">
                            <path d="m18 6-12 12M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <div id="custom-products-list">
                    <!-- Custom products will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Insecticide Database
        const insecticideData = {
            malathion_57ec: {
                name: 'Malathion 57% EC',
                chemical_class: 'Organophosphate',
                active_ingredient: 'Malathion',
                concentration: '57% EC',
                common_products: ['Fyfanon ULV', 'Malathion 57EC', 'Cythion ULV'],
                fogging_dilution: 0.8,
                spraying_dilution: 2.5,
                application_rate_fogging: 1.2,
                application_rate_spraying: 50,
                compatible_solvents: ['oil', 'water'],
                indoor_outdoor: ['indoor', 'outdoor'],
                phe_number: 'PHE/INS/001',
                safety_warnings: [
                    'Gunakan alat perlindungan diri (PPE) yang lengkap termasuk respirator',
                    'Jangan aplikasi semasa cuaca berangin (>10 km/j)',
                    'Elakkan aplikasi ketika hujan atau kelembapan >85%',
                    'Simpan dalam suhu sejuk, jauh dari kanak-kanak',
                    'Cuci tangan dan peralatan selepas penggunaan'
                ],
                environmental_warnings: [
                    'Toksik kepada lebah dan serangga berfaedah',
                    'Jangan aplikasi berhampiran kolam ikan'
                ]
            },
            pirimiphos_methyl: {
                name: 'Pirimiphos-methyl 50% EC',
                chemical_class: 'Organophosphate',
                active_ingredient: 'Pirimiphos-methyl',
                concentration: '50% EC',
                common_products: ['Actellic 50EC', 'Babolna Bio Pirimor'],
                fogging_dilution: 0.4,
                spraying_dilution: 1.5,
                application_rate_fogging: 0.8,
                application_rate_spraying: 35,
                compatible_solvents: ['oil', 'water'],
                indoor_outdoor: ['indoor', 'outdoor'],
                phe_number: 'PHE/INS/002',
                safety_warnings: [
                    'Gunakan masker dan sarung tangan getah',
                    'Elakkan penyedutan wap secara langsung',
                    'Jangan makan, minum atau merokok semasa aplikasi',
                    'Mandikan diri selepas penggunaan'
                ],
                environmental_warnings: [
                    'Moderately toxic kepada ikan',
                    'Elakkan pencemaran sumber air'
                ]
            },
            deltamethrin_25sc: {
                name: 'Deltamethrin 2.5% SC',
                chemical_class: 'Synthetic Pyrethroid',
                active_ingredient: 'Deltamethrin',
                concentration: '2.5% SC',
                common_products: ['K-Othrine SC25', 'Decis 2.5EC', 'DeltaGard'],
                fogging_dilution: 0.15,
                spraying_dilution: 0.025,
                application_rate_fogging: 0.3,
                application_rate_spraying: 20,
                compatible_solvents: ['oil', 'water'],
                indoor_outdoor: ['indoor', 'outdoor'],
                phe_number: 'PHE/INS/003',
                safety_warnings: [
                    'Gunakan PPE lengkap - sangat penting untuk pyrethroid',
                    'Elakkan kontak dengan kulit dan mata',
                    'Jangan aplikasi dalam ruang tertutup tanpa ventilasi',
                    'Simpan dalam bekas asal, label mesti utuh'
                ],
                environmental_warnings: [
                    'SANGAT TOKSIK kepada ikan dan udang',
                    'Sangat toksik kepada lebah',
                    'Jangan aplikasi berhampiran sungai, tasik atau laut',
                    'Elakkan aplikasi semasa musim pembiakan ikan'
                ]
            },
            cypermethrin_10ec: {
                name: 'Cypermethrin 10% EC',
                chemical_class: 'Synthetic Pyrethroid',
                active_ingredient: 'Cypermethrin',
                concentration: '10% EC',
                common_products: ['Cymbush 10EC', 'Ripcord 10EC', 'Sherpa 10EC'],
                fogging_dilution: 0.2,
                spraying_dilution: 0.05,
                application_rate_fogging: 0.4,
                application_rate_spraying: 25,
                compatible_solvents: ['oil', 'water'],
                indoor_outdoor: ['indoor', 'outdoor'],
                phe_number: 'PHE/INS/004',
                safety_warnings: [
                    'Pakai suit perlindungan dan respirator',
                    'Cuci peralatan dengan sabun alkaline',
                    'Jangan aplikasi lebih dari 2 kali sebulan di kawasan sama',
                    'Monitor untuk simptom keracunan pyrethroid'
                ],
                environmental_warnings: [
                    'Highly toxic kepada organisma akuatik',
                    'Boleh menyebabkan bioaccumulation'
                ]
            },
            permethrin_25ec: {
                name: 'Permethrin 25% EC',
                chemical_class: 'Synthetic Pyrethroid',
                active_ingredient: 'Permethrin',
                concentration: '25% EC',
                common_products: ['Ambush 25EC', 'Pounce 25EC', 'Outflank 25EC'],
                fogging_dilution: 0.1,
                spraying_dilution: 0.02,
                application_rate_fogging: 0.25,
                application_rate_spraying: 15,
                compatible_solvents: ['oil', 'water'],
                indoor_outdoor: ['indoor', 'outdoor'],
                phe_number: 'PHE/INS/005',
                safety_warnings: [
                    'Lebih selamat berbanding pyrethroid lain untuk manusia',
                    'Tetap gunakan PPE yang sesuai',
                    'Elakkan aplikasi berulang di kawasan sama',
                    'Pastikan ventilasi mencukupi'
                ],
                environmental_warnings: [
                    'Toksik kepada ikan dan arthropoda akuatik',
                    'Relatively safe untuk mamalia dan burung'
                ]
            },
            temephos_50ec: {
                name: 'Temephos 50% EC (Larvicide)',
                chemical_class: 'Organophosphate',
                active_ingredient: 'Temephos',
                concentration: '50% EC',
                common_products: ['Abate 500EC', 'Biothion'],
                fogging_dilution: 0.0,
                spraying_dilution: 0.0,
                application_rate_fogging: 0.0,
                application_rate_spraying: 0.0,
                larvicide_rate: 1.0,
                compatible_solvents: ['water'],
                indoor_outdoor: ['outdoor'],
                phe_number: 'PHE/LARV/001',
                safety_warnings: [
                    'Khusus untuk kawalan larva - BUKAN untuk fogging dewasa',
                    'Gunakan untuk tempat pembiakan nyamuk sahaja',
                    'Dos: 1ppm untuk air bertakung',
                    'Selamat untuk ikan pada kepekatan rendah'
                ],
                environmental_warnings: [
                    'Specifically designed untuk larviciding',
                    'Biodegradable dalam persekitaran akuatik'
                ]
            },
            bioallethrin_piperonyl: {
                name: 'Bioallethrin + Piperonyl Butoxide',
                chemical_class: 'Natural Pyrethroid + Synergist',
                active_ingredient: 'Bioallethrin 1% + PBO 5%',
                concentration: '6% EC',
                common_products: ['Pynosect', 'Sumithrin', 'Bio-Mist'],
                fogging_dilution: 0.5,
                spraying_dilution: 0.1,
                application_rate_fogging: 0.6,
                application_rate_spraying: 30,
                compatible_solvents: ['oil', 'water'],
                indoor_outdoor: ['indoor', 'outdoor'],
                phe_number: 'PHE/INS/006',
                safety_warnings: [
                    'Lebih selamat - berasaskan pyrethrin semulajadi',
                    'Sesuai untuk kawasan sensitif (hospital, sekolah)',
                    'Tetap gunakan PPE untuk aplikator',
                    'Kesan cepat tetapi residual effect pendek'
                ],
                environmental_warnings: [
                    'Biodegradable dengan cepat',
                    'Kurang persistant dalam persekitaran'
                ]
            },
            moskilla: {
                name: 'Moskilla',
                chemical_class: 'Synthetic Pyrethroid',
                active_ingredient: 'Metofluthrin',
                concentration: '0.76% w/w',
                common_products: ['X\'Mos Mini', 'Moskilla Aerosol'],
                fogging_dilution: 0.5, // 5ml per liter = 0.5%
                spraying_dilution: 0.05,
                application_rate_fogging: 0.2, // 200ml per 1000m³ = 0.2L per 1000m³
                application_rate_spraying: 20,
                outdoor_rate_per_hectare: 25, // 25ml per hectare as per ACM calculation
                compatible_solvents: ['oil', 'water'],
                indoor_outdoor: ['indoor', 'outdoor'],
                phe_number: 'LRMP.R1/9508',
                safety_warnings: [
                    'Jangan semburkan terus pada kulit atau badan',
                    'Tunggu 5 minit sebelum masuk bilik selepas penggunaan',
                    'Selamat untuk wanita mengandung dan kanak-kanak',
                    'Tanpa bau dan tidak meninggalkan kesan minyak'
                ],
                environmental_warnings: [
                    'Biodegradable dengan cepat',
                    'Residual effect yang pendek',
                    'Toksisiti rendah untuk mamalia'
                ]
            },
            actelic_50ec: {
                name: 'Actelic 50EC',
                chemical_class: 'Organophosphate',
                active_ingredient: 'Pirimiphos-methyl',
                concentration: '50% EC',
                common_products: ['Actellic 50EC', 'Actelic 50EC'],
                fogging_dilution: 0.4,
                spraying_dilution: 1.5,
                application_rate_fogging: 0.8,
                application_rate_spraying: 35,
                compatible_solvents: ['oil', 'water'],
                indoor_outdoor: ['indoor', 'outdoor'],
                phe_number: 'PHE/INS/007',
                safety_warnings: [
                    'Gunakan masker dan sarung tangan getah',
                    'Elakkan penyedutan wap secara langsung',
                    'Jangan makan, minum atau merokok semasa aplikasi',
                    'Cuci badan dengan bersih selepas penggunaan'
                ],
                environmental_warnings: [
                    'Moderately toxic kepada ikan',
                    'Elakkan pencemaran sumber air',
                    'Jangan aplikasi berhampiran kolam ikan'
                ]
            },
            sumithion_50ec: {
                name: 'Sumithion 50EC',
                chemical_class: 'Organophosphate',
                active_ingredient: 'Fenitrothion',
                concentration: '50% EC',
                common_products: ['Sumithion 50EC', 'Sumithion L-40'],
                fogging_dilution: 0.6,
                spraying_dilution: 2.0,
                application_rate_fogging: 1.0,
                application_rate_spraying: 45,
                compatible_solvents: ['oil', 'water'],
                indoor_outdoor: ['indoor', 'outdoor'],
                phe_number: 'PHE/INS/008',
                safety_warnings: [
                    'Gunakan PPE lengkap termasuk respirator',
                    'Organophosphate - berisiko keracunan cholinesterase',
                    'Elakkan aplikasi semasa cuaca panas',
                    'Monitor simptom keracunan (sakit kepala, loya)'
                ],
                environmental_warnings: [
                    'Toksik kepada lebah dan serangga berfaedah',
                    'Jangan aplikasi semasa musim bunga',
                    'Boleh mencemarkan sumber air bawah tanah'
                ]
            },
            malathion_generic: {
                name: 'Malathion (Generic)',
                chemical_class: 'Organophosphate',
                active_ingredient: 'Malathion',
                concentration: '50% EC',
                common_products: ['Malathion 50EC', 'Generic Malathion'],
                fogging_dilution: 0.8,
                spraying_dilution: 2.5,
                application_rate_fogging: 1.2,
                application_rate_spraying: 50,
                compatible_solvents: ['oil', 'water'],
                indoor_outdoor: ['indoor', 'outdoor'],
                phe_number: 'PHE/INS/009',
                safety_warnings: [
                    'Lebih selamat berbanding organophosphate lain',
                    'Tetap gunakan PPE yang sesuai',
                    'Elakkan aplikasi berulang dalam masa singkat',
                    'Simpan dalam suhu sejuk dan kering'
                ],
                environmental_warnings: [
                    'Toksik kepada lebah pada kepekatan tinggi',
                    'Relatively safe untuk ikan pada dos rendah',
                    'Biodegradable dalam persekitaran'
                ]
            },
            aqua_resigen: {
                name: 'Aqua Resigen',
                chemical_class: 'Multi-active Pyrethroid',
                active_ingredient: 'S-bioallethrin 0.14% + Permethrin 10.27% + PBO 9.84%',
                concentration: 'EW formulation',
                common_products: ['Aqua Resigen EW', 'Aqua Reslin Super'],
                fogging_dilution: 0.2,
                spraying_dilution: 0.08,
                application_rate_fogging: 0.4,
                application_rate_spraying: 25,
                compatible_solvents: ['water'],
                indoor_outdoor: ['indoor', 'outdoor'],
                phe_number: 'PHE/INS/010',
                safety_warnings: [
                    'Gunakan dengan air sahaja - JANGAN gunakan minyak',
                    'FFAST technology - enhanced performance dengan air',
                    'Tanpa bau dan tidak meninggalkan kesan',
                    'Sesuai untuk aplikasi dalaman dan luaran'
                ],
                environmental_warnings: [
                    'Environmentally-sensitive formulation',
                    'Kurangkan pencemaran berbanding minyak-based',
                    'Toksik kepada organisma akuatik - elakkan sumber air'
                ]
            },
            aqua_kothrine: {
                name: 'Aqua K-Othrine EW',
                chemical_class: 'Synthetic Pyrethroid',
                active_ingredient: 'Deltamethrin',
                concentration: '2.0% w/w EW',
                common_products: ['Aqua K-Othrine EW', 'K-Othrine Water Base'],
                fogging_dilution: 0.15,
                spraying_dilution: 0.03,
                application_rate_fogging: 0.3,
                application_rate_spraying: 20,
                compatible_solvents: ['water'],
                indoor_outdoor: ['indoor', 'outdoor'],
                phe_number: 'PHE/INS/011',
                safety_warnings: [
                    'Produk berasaskan air - tidak mudah terbakar',
                    'FFAST technology dengan formula unik',
                    'WHO-PQ listed dan diluluskan (Ref.No.: 008-001)',
                    'Elakkan aplikasi ketika kelajuan angin melebihi 10 km/j'
                ],
                environmental_warnings: [
                    'Kurangkan pencemaran dibanding oil-based',
                    'SANGAT TOKSIK kepada ikan dan organisma akuatik',
                    'Toksik kepada lebah - elakkan aplikasi semasa musim bunga',
                    'Jangan aplikasi berhampiran sumber air'
                ]
            },
            resigen: {
                name: 'Resigen',
                chemical_class: 'Multi-active Pyrethroid',
                active_ingredient: 'Permethrin + S-bioallethrin + PBO',
                concentration: 'EC formulation',
                common_products: ['Resigen EC', 'Bayer Resigen'],
                fogging_dilution: 1.0, // 10ml per liter = 1%
                spraying_dilution: 10.0, // 100ml per liter = 10%
                application_rate_fogging: 10, // 10 litre/ha for thermal fogging
                application_rate_spraying: 1000, // 1 litre/ha for ULV
                fogging_indoor_rate: 0.5, // 1 litre per 2000m³
                ulv_indoor_rate: 0.05, // 100ml per 2000m³
                compatible_solvents: ['oil', 'water'],
                indoor_outdoor: ['indoor', 'outdoor'],
                phe_number: 'JIRP.P/0120/002',
                safety_warnings: [
                    'Boleh digunakan dengan air atau diesel/kerosene',
                    'Gunakan PPE yang sesuai',
                    'Elakkan aplikasi dalam ruang tertutup tanpa ventilasi',
                    'Ikut jadual penggunaan yang ditetapkan'
                ],
                environmental_warnings: [
                    'Toksik kepada organisma akuatik',
                    'Elakkan pencemaran sumber air',
                    'Gunakan mengikut label untuk mengelakkan rintangan'
                ]
            },
            deltacide: {
                name: 'Deltacide',
                chemical_class: 'Synthetic Pyrethroid',
                active_ingredient: 'Deltamethrin',
                concentration: 'Emulsifiable Concentrate',
                common_products: ['Deltacide EC', 'Bayer Deltacide'],
                fogging_dilution: 1.0, // 10ml per liter = 1% (low output)
                fogging_dilution_high: 0.2, // 2ml per liter = 0.2% (high output)
                spraying_dilution: 20.0, // 200ml per liter = 20% (ULV low output)
                spraying_dilution_high: 10.0, // 100ml per liter = 10% (ULV high output)
                application_rate_fogging: 10, // 10 litre/ha (low output)
                application_rate_fogging_high: 50, // 50 litre/ha (high output)
                application_rate_spraying: 0.5, // 500ml/ha (ULV low output)
                application_rate_spraying_high: 1.0, // 1 litre/ha (ULV high output)
                indoor_rate: 0.5, // 1 litre per 2000m³
                compatible_solvents: ['water'],
                indoor_outdoor: ['indoor', 'outdoor'],
                phe_number: 'JIRP.P/0120/006',
                safety_warnings: [
                    'Produk berasaskan air - tidak mudah terbakar',
                    'Gunakan untuk kawasan yang mungkin ada serangga',
                    'Kadar pencairan berbeza mengikut jenis mesin',
                    'Ikut arahan label sebelum guna'
                ],
                environmental_warnings: [
                    'SANGAT TOKSIK kepada ikan dan organisma akuatik',
                    'Elakkan aplikasi berhampiran sumber air',
                    'Gunakan hanya mengikut keperluan'
                ]
            },
            abate_500: {
                name: 'ABATE 500',
                chemical_class: 'Organophosphate',
                active_ingredient: 'Temephos',
                concentration: '47.4% w/w',
                common_products: ['ABATE 500 EC', 'Temephos 500'],
                fogging_dilution: 0.0, // Not for fogging
                spraying_dilution: 0.0, // Not for spraying
                application_rate_fogging: 0.0,
                application_rate_spraying: 0.0,
                larvicide_rate: 1.2, // 12ml per 100 litres = 120ppm, but typically used at 1ppm
                ulv_adult_rate: 400, // 400ml ULV for adults per hectare
                compatible_solvents: ['water'],
                indoor_outdoor: ['outdoor'],
                phe_number: 'Temephos Registration',
                safety_warnings: [
                    'Khusus untuk kawalan larva dan dewasa (ULV)',
                    'ABATE 500: 12ml untuk 100 liter air (larva)',
                    'ULV dewasa: 160ml untuk 400ml solution (25L/ha)',
                    'Selamat untuk ikan pada kepekatan rendah'
                ],
                environmental_warnings: [
                    'Specifically designed untuk larviciding',
                    'Biodegradable dalam persekitaran akuatik',
                    'Boleh digunakan dalam sumber air'
                ]
            },
            abate_11g: {
                name: 'ABATE 1.1G',
                chemical_class: 'Organophosphate',
                active_ingredient: 'Temephos',
                concentration: '1.1% w/w granule',
                common_products: ['ABATE 1.1G Granule'],
                fogging_dilution: 0.0,
                spraying_dilution: 0.0,
                application_rate_fogging: 0.0,
                application_rate_spraying: 0.0,
                larvicide_rate: 5, // 5g per 10m² or 5kg per hectare
                compatible_solvents: ['water'],
                indoor_outdoor: ['outdoor'],
                phe_number: 'Temephos Granule Registration',
                safety_warnings: [
                    'Granule untuk kawalan larva sahaja',
                    'Taburkan terus dalam air bertakung',
                    'Dos: 5g per 10m² atau 5kg per hektar',
                    'Aplikasi berulang setiap 2-3 bulan'
                ],
                environmental_warnings: [
                    'Specifically designed untuk larviciding',
                    'Biodegradable dalam persekitaran akuatik',
                    'Selamat untuk ekosistem air'
                ]
            }
        };

        // Equipment specifications
        const equipmentSpecs = {
            fogger_capacity: 20,
            sprayer_capacity: 16,
            fogging_coverage_per_charge: 5000,
            spraying_coverage_per_charge: 400
        };

        // Global variables
        let customProducts = [];
        let editingProduct = null;

        // Load custom products from localStorage
        function loadCustomProducts() {
            const saved = localStorage.getItem('customInsecticideProducts');
            if (saved) {
                customProducts = JSON.parse(saved);
                updateProductDropdown();
                updateManageButton();
            }
        }

        // Save custom products to localStorage
        function saveCustomProducts() {
            localStorage.setItem('customInsecticideProducts', JSON.stringify(customProducts));
        }

        // Get all products (default + custom)
        function getAllProducts() {
            const allProducts = { ...insecticideData };
            customProducts.forEach(product => {
                allProducts[product.id] = {
                    ...product,
                    common_products: product.common_products.split(',').map(p => p.trim()),
                    safety_warnings: product.safety_warnings.split('\n').filter(w => w.trim()),
                    environmental_warnings: product.environmental_warnings.split('\n').filter(w => w.trim())
                };
            });
            return allProducts;
        }

        // Update product dropdown
        function updateProductDropdown() {
            const select = document.getElementById('insecticide_type');
            const currentValue = select.value;
            
            // Remove existing custom options
            const customOptgroup = select.querySelector('optgroup[label*="Custom"]');
            if (customOptgroup) {
                customOptgroup.remove();
            }

            // Add custom products if any exist
            if (customProducts.length > 0) {
                const customOptgroup = document.createElement('optgroup');
                customOptgroup.label = 'Custom Products';
                
                customProducts.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} (${product.chemical_class})`;
                    customOptgroup.appendChild(option);
                });
                
                select.appendChild(customOptgroup);
            }

            // Restore selection if still valid
            if (currentValue && [...select.options].some(opt => opt.value === currentValue)) {
                select.value = currentValue;
            }
            
            updateProductInfo();
        }

        // Update manage button visibility
        function updateManageButton() {
            const manageBtn = document.getElementById('btn-manage-products');
            manageBtn.style.display = customProducts.length > 0 ? 'flex' : 'none';
        }

        // Update calculation mode interface
        function updateCalculationMode() {
            const mode = document.getElementById('calculation_mode').value;
            const standardInputs = document.getElementById('standard-inputs');
            const equipmentSelection = document.getElementById('equipment-selection');
            const estimatedIndoorDiv = document.getElementById('estimated-indoor-div');
            const modeDescription = document.getElementById('mode-description');
            const equipmentOptions = document.getElementById('equipment-options');

            // Reset display
            standardInputs.style.display = 'block';
            equipmentSelection.style.display = 'none';
            estimatedIndoorDiv.style.display = 'none';

            if (mode === 'standard') {
                modeDescription.innerHTML = '<strong>Standard:</strong> Masukkan data kawasan dan rumah secara manual';
            } else if (mode === 'single_case') {
                standardInputs.style.display = 'none';
                equipmentSelection.style.display = 'block';
                estimatedIndoorDiv.style.display = 'block';
                
                modeDescription.innerHTML = `
                    <strong>Kes Tunggal (200m radius):</strong><br>
                    • Thermal fogging untuk kawasan 200m radius<br>
                    • Survey pagi untuk tentukan isipadu dalaman<br>
                    • Kawalan petang berdasarkan persiapan
                `;

                equipmentOptions.innerHTML = `
                    <div class="p-3 bg-blue-50 border rounded-lg">
                        <div class="flex items-center gap-2">
                            <input type="radio" id="thermal_only" name="equipment" value="thermal" checked>
                            <label for="thermal_only" class="font-medium">Thermal Fogging Sahaja</label>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">Kawasan outdoor: 200m radius (12.57 hektar)</p>
                    </div>
                `;
            } else if (mode === 'outbreak') {
                standardInputs.style.display = 'none';
                equipmentSelection.style.display = 'block';
                estimatedIndoorDiv.style.display = 'block';
                
                modeDescription.innerHTML = `
                    <strong>Wabak (400m radius):</strong><br>
                    • Thermal fogging + ULV untuk kawasan 400m radius<br>
                    • Survey pagi untuk tentukan isipadu dalaman<br>
                    • Kawalan petang dengan 2 jenis mesin
                `;

                equipmentOptions.innerHTML = `
                    <div class="space-y-3">
                        <div class="p-3 bg-red-50 border rounded-lg">
                            <div class="flex items-center gap-2">
                                <input type="radio" id="thermal_ulv" name="equipment" value="thermal_ulv" checked>
                                <label for="thermal_ulv" class="font-medium">Thermal Fogging + ULV</label>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">Kawasan outdoor: 400m radius (50.27 hektar)</p>
                        </div>
                        <div class="p-3 bg-yellow-50 border rounded-lg">
                            <div class="flex items-center gap-2">
                                <input type="radio" id="thermal_only_outbreak" name="equipment" value="thermal">
                                <label for="thermal_only_outbreak" class="font-medium">Thermal Fogging Sahaja</label>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">Jika ULV tidak tersedia</p>
                        </div>
                    </div>
                `;
            }
        }
        function updateProductInfo() {
            const selectedValue = document.getElementById('insecticide_type').value;
            const solventType = document.getElementById('solvent_type').value;
            const locationType = document.getElementById('location_type').value;
            const applicationMethod = document.getElementById('application_method').value;
            
            const allProducts = getAllProducts();
            const product = allProducts[selectedValue];
            const infoDiv = document.getElementById('product-info');
            const warningsDiv = document.getElementById('product-warnings');
            const solventWarningsDiv = document.getElementById('solvent-warnings');
            const locationWarningsDiv = document.getElementById('location-warnings');

            if (product) {
                infoDiv.innerHTML = `
                    <div><strong>Produk:</strong> ${product.common_products.join(', ')}</div>
                    <div><strong>No. PHE:</strong> ${product.phe_number}</div>
                    <div><strong>Kelas:</strong> ${product.chemical_class}</div>
                    <div><strong>Pelarut Sesuai:</strong> ${product.compatible_solvents ? product.compatible_solvents.map(s => s === 'water' ? 'Air' : 'Minyak').join(', ') : 'Semua'}</div>
                    <div><strong>Lokasi Sesuai:</strong> ${product.indoor_outdoor ? product.indoor_outdoor.map(l => l === 'indoor' ? 'Dalaman' : 'Luaran').join(', ') : 'Semua'}</div>
                    ${selectedValue.startsWith('custom_') ? '<div class="text-blue-600 mt-1">✓ Custom Product</div>' : ''}
                `;

                // Check solvent compatibility
                let solventWarning = '';
                if (product.compatible_solvents && !product.compatible_solvents.includes(solventType)) {
                    const compatibleSolvents = product.compatible_solvents.map(s => s === 'water' ? 'Air' : 'Minyak').join(' atau ');
                    solventWarning = `<p class="text-sm text-red-600">⚠️ Produk ini hanya sesuai dengan ${compatibleSolvents}</p>`;
                }
                solventWarningsDiv.innerHTML = solventWarning;

                // Check location compatibility
                let locationWarning = '';
                if (product.indoor_outdoor && !product.indoor_outdoor.includes(locationType)) {
                    const compatibleLocations = product.indoor_outdoor.map(l => l === 'indoor' ? 'Dalaman' : 'Luaran').join(' atau ');
                    locationWarning = `<p class="text-sm text-red-600">⚠️ Produk ini hanya sesuai untuk ${compatibleLocations}</p>`;
                }
                locationWarningsDiv.innerHTML = locationWarning;

                // Update other warnings
                let warningsHtml = '';
                if (selectedValue === 'temephos_50ec' && applicationMethod !== 'larvicide') {
                    warningsHtml = '<p class="text-sm text-orange-600 mt-1">⚠️ Temephos adalah khusus untuk kawalan larva sahaja</p>';
                }
                
                if (selectedValue.startsWith('custom_') && applicationMethod === 'larvicide' && !product.larvicide_rate) {
                    warningsHtml += '<p class="text-sm text-red-600 mt-1">⚠️ Produk ini tidak mempunyai kadar larvicide yang ditetapkan</p>';
                }

                // Special warnings for water-based products
                if (product.compatible_solvents && product.compatible_solvents.length === 1 && product.compatible_solvents[0] === 'water') {
                    warningsHtml += '<p class="text-sm text-blue-600 mt-1">ℹ️ Produk FFAST technology - gunakan air sahaja</p>';
                }
                
                warningsDiv.innerHTML = warningsHtml;
            }
        }

        // Reset form
        function resetForm() {
            document.getElementById('bilangan_rumah').value = '';
            document.getElementById('isipadu_rumah').value = '';
            document.getElementById('keluasan_kawasan').value = '';
            document.getElementById('insecticide_type').value = 'malathion_57ec';
            document.getElementById('application_method').value = 'fogging';
            document.getElementById('solvent_type').value = 'water';
            document.getElementById('location_type').value = 'outdoor';
            document.getElementById('calculation_mode').value = 'standard';
            document.getElementById('estimated_indoor_volume').value = '';
            
            // Reset equipment selection
            const thermalOnly = document.getElementById('thermal_only');
            if (thermalOnly) thermalOnly.checked = true;
            
            document.getElementById('results-container').style.display = 'none';
            document.getElementById('no-results').style.display = 'block';
            
            updateCalculationMode();
            updateProductInfo();
        }

        // Clear add product form
        function clearAddProductForm() {
            document.getElementById('new-name').value = '';
            document.getElementById('new-chemical-class').value = 'Organophosphate';
            document.getElementById('new-active-ingredient').value = '';
            document.getElementById('new-concentration').value = '';
            document.getElementById('new-phe-number').value = '';
            document.getElementById('new-common-products').value = '';
            document.getElementById('new-fogging-dilution').value = '';
            document.getElementById('new-spraying-dilution').value = '';
            document.getElementById('new-application-rate-fogging').value = '';
            document.getElementById('new-application-rate-spraying').value = '';
            document.getElementById('new-larvicide-rate').value = '';
            document.getElementById('new-safety-warnings').value = '';
            document.getElementById('new-environmental-warnings').value = '';
            
            // Clear multiple select fields
            document.getElementById('new-compatible-solvents').selectedIndex = -1;
            document.getElementById('new-indoor-outdoor').selectedIndex = -1;
        }

        // Add custom product
        function addCustomProduct() {
            const name = document.getElementById('new-name').value.trim();
            const activeIngredient = document.getElementById('new-active-ingredient').value.trim();

            if (!name || !activeIngredient) {
                alert('Sila isi nama produk dan bahan aktif / Please fill in product name and active ingredient');
                return;
            }

            // Get selected solvent types
            const solventSelect = document.getElementById('new-compatible-solvents');
            const selectedSolvents = Array.from(solventSelect.selectedOptions).map(option => option.value);
            
            // Get selected locations
            const locationSelect = document.getElementById('new-indoor-outdoor');
            const selectedLocations = Array.from(locationSelect.selectedOptions).map(option => option.value);

            const productId = editingProduct ? editingProduct.id : `custom_${Date.now()}`;
            const productData = {
                id: productId,
                name: name,
                chemical_class: document.getElementById('new-chemical-class').value,
                active_ingredient: activeIngredient,
                concentration: document.getElementById('new-concentration').value,
                common_products: document.getElementById('new-common-products').value || name,
                fogging_dilution: parseFloat(document.getElementById('new-fogging-dilution').value) || 0,
                spraying_dilution: parseFloat(document.getElementById('new-spraying-dilution').value) || 0,
                application_rate_fogging: parseFloat(document.getElementById('new-application-rate-fogging').value) || 0,
                application_rate_spraying: parseFloat(document.getElementById('new-application-rate-spraying').value) || 0,
                larvicide_rate: parseFloat(document.getElementById('new-larvicide-rate').value) || 0,
                compatible_solvents: selectedSolvents.length > 0 ? selectedSolvents : ['water', 'oil'],
                indoor_outdoor: selectedLocations.length > 0 ? selectedLocations : ['indoor', 'outdoor'],
                phe_number: document.getElementById('new-phe-number').value,
                safety_warnings: document.getElementById('new-safety-warnings').value,
                environmental_warnings: document.getElementById('new-environmental-warnings').value
            };

            if (editingProduct) {
                // Update existing product
                const index = customProducts.findIndex(p => p.id === editingProduct.id);
                customProducts[index] = productData;
                alert('Produk berjaya dikemaskini / Product successfully updated');
            } else {
                // Add new product
                customProducts.push(productData);
                alert('Produk baru berjaya ditambah / New product successfully added');
            }

            saveCustomProducts();
            updateProductDropdown();
            updateManageButton();
            closeAddProductModal();
        }

        // Edit custom product
        function editCustomProduct(productId) {
            const product = customProducts.find(p => p.id === productId);
            if (!product) return;

            editingProduct = product;
            
            // Populate form
            document.getElementById('new-name').value = product.name;
            document.getElementById('new-chemical-class').value = product.chemical_class;
            document.getElementById('new-active-ingredient').value = product.active_ingredient;
            document.getElementById('new-concentration').value = product.concentration;
            document.getElementById('new-phe-number').value = product.phe_number;
            document.getElementById('new-common-products').value = product.common_products;
            document.getElementById('new-fogging-dilution').value = product.fogging_dilution;
            document.getElementById('new-spraying-dilution').value = product.spraying_dilution;
            document.getElementById('new-application-rate-fogging').value = product.application_rate_fogging;
            document.getElementById('new-application-rate-spraying').value = product.application_rate_spraying;
            document.getElementById('new-larvicide-rate').value = product.larvicide_rate;
            document.getElementById('new-safety-warnings').value = product.safety_warnings;
            document.getElementById('new-environmental-warnings').value = product.environmental_warnings;

            // Populate multi-select fields
            const solventSelect = document.getElementById('new-compatible-solvents');
            Array.from(solventSelect.options).forEach(option => {
                option.selected = product.compatible_solvents && product.compatible_solvents.includes(option.value);
            });

            const locationSelect = document.getElementById('new-indoor-outdoor');
            Array.from(locationSelect.options).forEach(option => {
                option.selected = product.indoor_outdoor && product.indoor_outdoor.includes(option.value);
            });

            // Update modal title and button
            document.getElementById('modal-title').textContent = 'Edit Produk / Edit Product';
            document.getElementById('save-button-text').textContent = 'Kemaskini / Update';

            // Show modal
            document.getElementById('add-product-modal').classList.add('show');
            document.getElementById('manage-products-modal').classList.remove('show');
        }

        // Delete custom product
        function deleteCustomProduct(productId) {
            if (confirm('Adakah anda pasti untuk memadam produk ini? / Are you sure you want to delete this product?')) {
                customProducts = customProducts.filter(p => p.id !== productId);
                
                // Reset selection if deleted product was selected
                if (document.getElementById('insecticide_type').value === productId) {
                    document.getElementById('insecticide_type').value = 'malathion_57ec';
                    updateProductInfo();
                }
                
                saveCustomProducts();
                updateProductDropdown();
                updateManageButton();
                updateManageProductsList();
            }
        }

        // Update manage products list
        function updateManageProductsList() {
            const container = document.getElementById('custom-products-list');
            
            if (customProducts.length === 0) {
                container.innerHTML = `
                    <p class="text-center text-gray-500 py-8">
                        Tiada produk custom ditambah lagi / No custom products added yet
                    </p>
                `;
                return;
            }

            container.innerHTML = customProducts.map(product => `
                <div class="border rounded-lg p-4 flex justify-between items-center mb-3">
                    <div>
                        <h3 class="font-semibold">${product.name}</h3>
                        <p class="text-sm text-gray-600">
                            ${product.chemical_class} | ${product.active_ingredient} | ${product.concentration}
                        </p>
                        <p class="text-xs text-gray-500">PHE: ${product.phe_number}</p>
                        <p class="text-xs text-blue-600">
                            Pelarut: ${product.compatible_solvents ? product.compatible_solvents.map(s => s === 'water' ? 'Air' : 'Minyak').join(', ') : 'Semua'} | 
                            Lokasi: ${product.indoor_outdoor ? product.indoor_outdoor.map(l => l === 'indoor' ? 'Dalaman' : 'Luaran').join(', ') : 'Semua'}
                        </p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editCustomProduct('${product.id}')" class="text-blue-600 hover:text-blue-800 p-1">
                            <svg class="w-4 h-4" viewBox="0 0 24 24">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="m18.5 2.5 a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4Z"/>
                            </svg>
                        </button>
                        <button onclick="deleteCustomProduct('${product.id}')" class="text-red-600 hover:text-red-800 p-1">
                            <svg class="w-4 h-4" viewBox="0 0 24 24">
                                <path d="m3 6 3 0 m0 0 a3 3 0 0 1 3-3h6a3 3 0 0 1 3 3M6 6v14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V6M10 11v6M14 11v6"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Close add product modal
        function closeAddProductModal() {
            document.getElementById('add-product-modal').classList.remove('show');
            clearAddProductForm();
            editingProduct = null;
            document.getElementById('modal-title').textContent = 'Tambah Produk Baru / Add New Product';
            document.getElementById('save-button-text').textContent = 'Simpan / Save';
        }

        // Calculate dosage
        function calculateDosage() {
            const calculationMode = document.getElementById('calculation_mode').value;
            const insecticideType = document.getElementById('insecticide_type').value;
            const applicationMethod = document.getElementById('application_method').value;
            const solventType = document.getElementById('solvent_type').value;
            const locationType = document.getElementById('location_type').value;

            const allProducts = getAllProducts();
            const insecticide = allProducts[insecticideType];

            if (!insecticide) {
                alert('Produk yang dipilih tidak dijumpai / Selected product not found');
                return;
            }

            // Check product compatibility
            if (insecticide.compatible_solvents && !insecticide.compatible_solvents.includes(solventType)) {
                const compatibleSolvents = insecticide.compatible_solvents.map(s => s === 'water' ? 'Air' : 'Minyak').join(' atau ');
                alert(`Produk ini tidak serasi dengan ${solventType === 'water' ? 'air' : 'minyak'}. Sila gunakan ${compatibleSolvents}.`);
                return;
            }

            if (insecticide.indoor_outdoor && !insecticide.indoor_outdoor.includes(locationType)) {
                const compatibleLocations = insecticide.indoor_outdoor.map(l => l === 'indoor' ? 'Dalaman' : 'Luaran').join(' atau ');
                alert(`Produk ini tidak sesuai untuk ${locationType === 'indoor' ? 'dalaman' : 'luaran'}. Sila gunakan untuk ${compatibleLocations}.`);
                return;
            }

            if (insecticideType === 'temephos_50ec' && applicationMethod !== 'larvicide') {
                alert('Temephos adalah khusus untuk kawalan larva sahaja. Sila pilih produk lain untuk fogging/spraying.');
                return;
            }

            let calculations = {};

            if (calculationMode === 'standard') {
                // Standard calculation (existing logic)
                const bilanganRumah = document.getElementById('bilangan_rumah').value;
                const isipaduRumah = document.getElementById('isipadu_rumah').value;
                const keluasanKawasan = document.getElementById('keluasan_kawasan').value;

                if (!bilanganRumah || !isipaduRumah || !keluasanKawasan) {
                    alert('Sila isi semua maklumat yang diperlukan / Please fill in all required information');
                    return;
                }

                const houses = parseInt(bilanganRumah);
                const volumePerHouse = parseFloat(isipaduRumah);
                const areaHectares = parseFloat(keluasanKawasan);
                const totalVolume = houses * volumePerHouse;
                const totalArea = areaHectares * 10000;

                calculations = calculateStandardDosage(insecticide, applicationMethod, totalVolume, totalArea, solventType);
                calculations.scenario = 'Standard';
                calculations.totalVolume = totalVolume;
                calculations.totalArea = totalArea;

            } else {
                // Scenario-based calculation
                const estimatedIndoorVolume = parseFloat(document.getElementById('estimated_indoor_volume').value) || 0;
                const equipmentType = document.querySelector('input[name="equipment"]:checked')?.value;

                if (!equipmentType) {
                    alert('Sila pilih jenis peralatan / Please select equipment type');
                    return;
                }

                let radius, outdoorArea;
                if (calculationMode === 'single_case') {
                    radius = 200; // meters
                    outdoorArea = Math.PI * Math.pow(radius, 2); // m²
                    calculations.scenario = 'Kes Tunggal (200m radius)';
                } else {
                    radius = 400; // meters  
                    outdoorArea = Math.PI * Math.pow(radius, 2); // m²
                    calculations.scenario = 'Wabak (400m radius)';
                }

                const outdoorAreaHectares = outdoorArea / 10000;

                // Calculate outdoor requirements
                let outdoorCalc = {};
                if (applicationMethod === 'fogging') {
                    if (insecticide.name === 'Moskilla') {
                        // Use ACM calculation method for Moskilla
                        // 25ml per hectare (as per ACM document)
                        const insecticideAmount = outdoorAreaHectares * 25 / 1000; // Convert ml to L
                        const solutionNeeded = insecticideAmount / (5 / 1000); // 5ml per liter dilution
                        const solventAmount = solutionNeeded - insecticideAmount;

                        outdoorCalc = {
                            solutionNeeded: solutionNeeded,
                            insecticideAmount: insecticideAmount,
                            solventAmount: solventAmount,
                            concentrationPercent: 0.5 // 5ml per liter = 0.5%
                        };
                    } else {
                        // Standard calculation for other products
                        const dilutionRate = insecticide.fogging_dilution / 100;
                        const solutionNeeded = outdoorArea * insecticide.application_rate_fogging / 1000000; // Convert to liters
                        const insecticideAmount = solutionNeeded * dilutionRate;
                        const solventAmount = solutionNeeded - insecticideAmount;

                        outdoorCalc = {
                            solutionNeeded: solutionNeeded,
                            insecticideAmount: insecticideAmount,
                            solventAmount: solventAmount,
                            concentrationPercent: insecticide.fogging_dilution
                        };
                    }
                } else if (applicationMethod === 'spraying') {
                    const dilutionRate = insecticide.spraying_dilution / 100;
                    const solutionNeeded = outdoorArea * insecticide.application_rate_spraying / 1000; // Liters
                    const insecticideAmount = solutionNeeded * dilutionRate;
                    const solventAmount = solutionNeeded - insecticideAmount;

                    outdoorCalc = {
                        solutionNeeded: solutionNeeded,
                        insecticideAmount: insecticideAmount,
                        solventAmount: solventAmount,
                        concentrationPercent: insecticide.spraying_dilution
                    };
                }

                // Calculate indoor requirements (if estimated)
                let indoorCalc = { solutionNeeded: 0, insecticideAmount: 0, solventAmount: 0 };
                if (estimatedIndoorVolume > 0) {
                    if (applicationMethod === 'fogging') {
                        if (insecticide.name === 'Moskilla') {
                            // Use ACM calculation method: 200ml solution per 1000m³
                            const solutionNeeded = estimatedIndoorVolume * 0.2 / 1000; // 200ml per 1000m³
                            const insecticideAmount = solutionNeeded * (5 / 1000); // 5ml per liter
                            const solventAmount = solutionNeeded - insecticideAmount;

                            indoorCalc = {
                                solutionNeeded: solutionNeeded,
                                insecticideAmount: insecticideAmount,
                                solventAmount: solventAmount
                            };
                        } else {
                            // Standard calculation for other products
                            const dilutionRate = insecticide.fogging_dilution / 100;
                            const solutionNeeded = estimatedIndoorVolume * insecticide.application_rate_fogging / 1000;
                            const insecticideAmount = solutionNeeded * dilutionRate;
                            const solventAmount = solutionNeeded - insecticideAmount;

                            indoorCalc = {
                                solutionNeeded: solutionNeeded,
                                insecticideAmount: insecticideAmount,
                                solventAmount: solventAmount
                            };
                        }
                    }
                }

                // Combined totals
                const totalSolution = outdoorCalc.solutionNeeded + indoorCalc.solutionNeeded;
                const totalInsecticide = outdoorCalc.insecticideAmount + indoorCalc.insecticideAmount;
                const totalSolvent = outdoorCalc.solventAmount + indoorCalc.solventAmount;

                // Equipment calculations
                const chargesNeeded = Math.ceil(totalSolution / equipmentSpecs.fogger_capacity);
                const equipmentNeeded = Math.ceil(chargesNeeded / 4); // 4 charges per operator per operation (as per ACM)

                calculations = {
                    scenario: calculationMode === 'single_case' ? 'Kes Tunggal (200m radius)' : 'Wabak (400m radius)',
                    radius: radius,
                    outdoorAreaHectares: outdoorAreaHectares.toFixed(2),
                    outdoorAreaM2: outdoorArea.toFixed(0),
                    estimatedIndoorVolume: estimatedIndoorVolume,
                    equipmentType: equipmentType,
                    
                    // Outdoor calculations
                    outdoorSolution: outdoorCalc.solutionNeeded.toFixed(2),
                    outdoorInsecticide: (outdoorCalc.insecticideAmount * 1000).toFixed(1),
                    outdoorSolvent: outdoorCalc.solventAmount.toFixed(2),
                    
                    // Indoor calculations  
                    indoorSolution: indoorCalc.solutionNeeded.toFixed(2),
                    indoorInsecticide: (indoorCalc.insecticideAmount * 1000).toFixed(1),
                    indoorSolvent: indoorCalc.solventAmount.toFixed(2),
                    
                    // Total calculations
                    solutionNeeded: totalSolution.toFixed(2),
                    insecticideAmount: totalInsecticide.toFixed(3),
                    insecticideAmountMl: (totalInsecticide * 1000).toFixed(1),
                    solventAmount: totalSolvent.toFixed(2),
                    solventType: solventType === 'water' ? 'Air' : 'Minyak',
                    
                    chargesNeeded: chargesNeeded,
                    chargesPerMachine: Math.ceil(chargesNeeded / equipmentNeeded),
                    equipmentNeeded: equipmentNeeded,
                    equipmentType: equipmentType === 'thermal_ulv' ? 'Thermal + ULV' : 'Thermal Fogging',
                    concentrationPercent: outdoorCalc.concentrationPercent,
                    
                    // ACM validation for 200m radius Moskilla
                    acm_validation: insecticide.name === 'Moskilla' && calculationMode === 'single_case' ? 
                        `ACM Standard: 16 caj untuk 200m radius (${(totalInsecticide * 1000).toFixed(0)}ml ≈ 315ml)` : null,
                    
                    applicationMethod: applicationMethod
                };
            }

            displayResults({
                ...calculations,
                insecticideName: insecticide.name,
                chemicalClass: insecticide.chemical_class,
                pheNumber: insecticide.phe_number,
                locationType: locationType === 'indoor' ? 'Dalaman' : 'Luaran',
                safetyWarnings: insecticide.safety_warnings || [],
                environmentalWarnings: insecticide.environmental_warnings || []
            });
        }

        // Helper function for standard calculations
        function calculateStandardDosage(insecticide, applicationMethod, totalVolume, totalArea, solventType) {
            if (applicationMethod === 'fogging') {
                const dilutionRate = insecticide.fogging_dilution / 100;
                let solutionNeeded, insecticideAmount;
                
                // Use ACM calculation method for Moskilla
                if (insecticide.name === 'Moskilla') {
                    // ACM method: 200ml solution per 1000m³
                    solutionNeeded = totalVolume * 0.2 / 1000; // 200ml per 1000m³
                    insecticideAmount = solutionNeeded * (5 / 1000); // 5ml per liter
                } else {
                    // Standard method for other products
                    solutionNeeded = totalVolume * insecticide.application_rate_fogging / 1000;
                    insecticideAmount = solutionNeeded * dilutionRate;
                }
                
                const solventAmount = solutionNeeded - insecticideAmount;
                const chargesNeeded = Math.ceil(solutionNeeded / equipmentSpecs.fogger_capacity);
                const foggersNeeded = Math.ceil(chargesNeeded / 4); // 4 charges per operator per operation

                return {
                    solutionNeeded: solutionNeeded.toFixed(2),
                    insecticideAmount: insecticideAmount.toFixed(3),
                    insecticideAmountMl: (insecticideAmount * 1000).toFixed(1),
                    solventAmount: solventAmount.toFixed(2),
                    solventType: solventType === 'water' ? 'Air' : 'Minyak',
                    chargesNeeded: chargesNeeded,
                    chargesPerMachine: Math.ceil(chargesNeeded / foggersNeeded),
                    equipmentNeeded: foggersNeeded,
                    equipmentType: 'Fogger',
                    dilutionRatio: insecticide.name === 'Moskilla' ? '1:200' : `1:${Math.round(100/insecticide.fogging_dilution - 1)}`,
                    concentrationPercent: insecticide.fogging_dilution,
                    applicationMethod: applicationMethod
                };
            } else if (applicationMethod === 'spraying') {
                const dilutionRate = insecticide.spraying_dilution / 100;
                const solutionNeeded = totalArea * insecticide.application_rate_spraying / 1000;
                const insecticideAmount = solutionNeeded * dilutionRate;
                const solventAmount = solutionNeeded - insecticideAmount;

                const chargesNeeded = Math.ceil(solutionNeeded / equipmentSpecs.sprayer_capacity);
                const sprayersNeeded = Math.ceil(chargesNeeded / 4);

                return {
                    solutionNeeded: solutionNeeded.toFixed(2),
                    insecticideAmount: insecticideAmount.toFixed(3),
                    insecticideAmountMl: (insecticideAmount * 1000).toFixed(1),
                    solventAmount: solventAmount.toFixed(2),
                    solventType: solventType === 'water' ? 'Air' : 'Minyak',
                    chargesNeeded: chargesNeeded,
                    chargesPerMachine: Math.ceil(chargesNeeded / sprayersNeeded),
                    equipmentNeeded: sprayersNeeded,
                    equipmentType: 'Sprayer',
                    dilutionRatio: `1:${Math.round(100/insecticide.spraying_dilution - 1)}`,
                    concentrationPercent: insecticide.spraying_dilution,
                    applicationMethod: applicationMethod
                };
            } else if (applicationMethod === 'larvicide') {
                // Handle larvicide calculations
                const breedingSitesEstimate = Math.ceil(totalVolume / 200 * 0.3); // Estimate based on volume
                const solutionPerSite = 10;
                const totalLarvicideSolution = breedingSitesEstimate * solutionPerSite;
                const insecticideAmount = totalLarvicideSolution * (insecticide.larvicide_rate / 1000000);

                return {
                    breedingSitesEstimate: breedingSitesEstimate,
                    solutionNeeded: totalLarvicideSolution.toFixed(2),
                    insecticideAmount: insecticideAmount.toFixed(3),
                    insecticideAmountMl: (insecticideAmount * 1000).toFixed(1),
                    solventAmount: (totalLarvicideSolution - insecticideAmount).toFixed(2),
                    solventType: 'Air',
                    concentrationPpm: insecticide.larvicide_rate,
                    applicationNote: 'Untuk kawalan larva di tempat pembiakan',
                    applicationMethod: applicationMethod
                };
            }
        }

        // Display results
        function displayResults(results) {
            const container = document.getElementById('results-container');
            const noResults = document.getElementById('no-results');

            let resultsHtml = '';

            if (results.scenario) {
                // Scenario-based results
                resultsHtml = `
                    <!-- Scenario Summary -->
                    <div class="bg-white p-4 rounded-lg border-l-4 border-red-500 mb-4">
                        <h3 class="font-semibold text-red-800 mb-2">Senario Respons / Response Scenario</h3>
                        <div class="grid grid-cols-1 gap-2 text-sm">
                            <div><strong>Senario:</strong> ${results.scenario}</div>
                            <div><strong>Radius Kawalan:</strong> ${results.radius}m</div>
                            <div><strong>Kawasan Luaran:</strong> ${results.outdoorAreaHectares} hektar (${results.outdoorAreaM2} m²)</div>
                            <div><strong>Anggaran Dalaman:</strong> ${results.estimatedIndoorVolume} m³</div>
                            <div><strong>Peralatan:</strong> ${results.equipmentType}</div>
                        </div>
                    </div>

                    <!-- Product Summary -->
                    <div class="bg-white p-4 rounded-lg border-l-4 border-blue-500 mb-4">
                        <h3 class="font-semibold text-blue-800 mb-2">Produk / Product</h3>
                        <div class="grid grid-cols-1 gap-2 text-sm">
                            <div><strong>Produk:</strong> ${results.insecticideName}</div>
                            <div><strong>Kelas Kimia:</strong> ${results.chemicalClass}</div>
                            <div><strong>No. PHE:</strong> ${results.pheNumber}</div>
                            <div><strong>Kaedah:</strong> ${results.applicationMethod}</div>
                            <div><strong>Pelarut:</strong> ${results.solventType}</div>
                        </div>
                    </div>

                    <!-- Breakdown by Location -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="bg-white p-4 rounded-lg border border-green-200">
                            <h3 class="font-semibold text-green-800 mb-3">Kawasan Luaran / Outdoor</h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Larutan / Solution:</span>
                                    <span class="font-semibold">${results.outdoorSolution} L</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Racun / Insecticide:</span>
                                    <span class="font-semibold">${results.outdoorInsecticide} mL</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>${results.solventType}:</span>
                                    <span class="font-semibold">${results.outdoorSolvent} L</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-blue-200">
                            <h3 class="font-semibold text-blue-800 mb-3">Anggaran Dalaman / Est. Indoor</h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Larutan / Solution:</span>
                                    <span class="font-semibold">${results.indoorSolution} L</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Racun / Insecticide:</span>
                                    <span class="font-semibold">${results.indoorInsecticide} mL</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>${results.solventType}:</span>
                                    <span class="font-semibold">${results.indoorSolvent} L</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Total Requirements -->
                    <div class="bg-white p-4 rounded-lg mb-4">
                        <h3 class="font-semibold text-purple-800 mb-3">Jumlah Keperluan / Total Requirements</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>Jumlah Larutan / Total Solution:</span>
                                <span class="font-semibold text-lg">${results.solutionNeeded} L</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Jumlah Racun Pekat / Total Concentrate:</span>
                                <span class="font-semibold text-lg">${results.insecticideAmountMl} mL</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Jumlah ${results.solventType} / Total Solvent:</span>
                                <span class="font-semibold text-lg">${results.solventAmount} L</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Kepekatan / Concentration:</span>
                                <span class="font-semibold">${results.concentrationPercent}%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Equipment Requirements -->
                    <div class="bg-white p-4 rounded-lg mb-4">
                        <h3 class="font-semibold text-orange-800 mb-3">Keperluan Peralatan / Equipment Requirements</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>Bilangan Caj / Number of Charges:</span>
                                <span class="font-semibold">${results.chargesNeeded}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Caj per Mesin / Charges per Machine:</span>
                                <span class="font-semibold">${results.chargesPerMachine}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Bilangan Mesin Diperlukan:</span>
                                <span class="font-semibold">${results.equipmentNeeded}</span>
                            </div>
                            ${results.acm_validation ? `
                                <div class="mt-2 p-2 bg-green-100 rounded text-sm text-green-800">
                                    <strong>✓ ${results.acm_validation}</strong>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Important Notes for Field Operations -->
                    <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg mb-4">
                        <h3 class="font-semibold text-yellow-800 mb-2">Nota Lapangan / Field Notes</h3>
                        <ul class="space-y-1 text-sm text-yellow-700">
                            <li>• Survey pagi akan menentukan isipadu dalaman sebenar</li>
                            <li>• Sediakan racun tambahan 10-15% untuk kontingensi</li>
                            <li>• Semak peralatan dan bateri sebelum keluar</li>
                            <li>• Koordinasi dengan pihak berkuasa tempatan</li>
                            <li>• Morning survey will determine actual indoor volume</li>
                            <li>• Prepare 10-15% extra insecticide for contingency</li>
                        </ul>
                    </div>

                    ${results.insecticideName === 'Moskilla' ? `
                        <!-- ACM Calculation Method -->
                        <div class="bg-green-50 border border-green-200 p-4 rounded-lg mb-4">
                            <h3 class="font-semibold text-green-800 mb-2">Kaedah Kiraan ACM / ACM Calculation Method</h3>
                            <div class="text-sm text-green-700 space-y-1">
                                <div><strong>Pencairan:</strong> 5ml Moskilla per 1 liter larutan (1:200)</div>
                                <div><strong>Dalaman:</strong> 200ml larutan per 1000m³</div>
                                <div><strong>Luaran:</strong> 25ml Moskilla per hektar</div>
                                <div><strong>Kapasiti Mesin:</strong> 4 liter per caj</div>
                                <div><strong>Rujukan:</strong> Agricultural Chemicals (M) Sdn Bhd - Official MOH Calculation</div>
                            </div>
                        </div>
                    ` : ''}
                `;
            } else {
                // Standard results (existing format)
                resultsHtml = `
                    <!-- Summary -->
                    <div class="bg-white p-4 rounded-lg border-l-4 border-blue-500 mb-4">
                        <h3 class="font-semibold text-blue-800 mb-2">Ringkasan / Summary</h3>
                        <div class="grid grid-cols-1 gap-2 text-sm">
                            <div><strong>Produk:</strong> ${results.insecticideName}</div>
                            <div><strong>Kelas Kimia:</strong> ${results.chemicalClass}</div>
                            <div><strong>No. PHE:</strong> ${results.pheNumber}</div>
                            <div><strong>Kaedah:</strong> ${results.applicationMethod}</div>
                            <div><strong>Pelarut:</strong> ${results.solventType}</div>
                            <div><strong>Lokasi:</strong> ${results.locationType}</div>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <div>Jumlah Rumah: ${document.getElementById('bilangan_rumah').value}</div>
                                <div>Kawasan: ${document.getElementById('keluasan_kawasan').value} hektar</div>
                            </div>
                        </div>
                    </div>

                    <!-- Dosage Results -->
                    <div class="bg-white p-4 rounded-lg mb-4">
                        <h3 class="font-semibold text-green-800 mb-3">Penggunaan Racun / Insecticide Usage</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>Jumlah Larutan / Total Solution:</span>
                                <span class="font-semibold">${results.solutionNeeded} L</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Racun Pekat / Concentrate:</span>
                                <span class="font-semibold">${results.insecticideAmountMl} mL</span>
                            </div>
                            <div class="flex justify-between">
                                <span>${results.solventType} / Solvent:</span>
                                <span class="font-semibold">${results.solventAmount} L</span>
                            </div>
                            ${results.dilutionRatio ? `
                                <div class="flex justify-between">
                                    <span>Nisbah Pencairan / Dilution Ratio:</span>
                                    <span class="font-semibold">${results.dilutionRatio}</span>
                                </div>
                            ` : ''}
                            ${results.concentrationPercent ? `
                                <div class="flex justify-between">
                                    <span>Kepekatan / Concentration:</span>
                                    <span class="font-semibold">${results.concentrationPercent}%</span>
                                </div>
                            ` : ''}
                            ${results.concentrationPpm ? `
                                <div class="flex justify-between">
                                    <span>Kepekatan Larvicide:</span>
                                    <span class="font-semibold">${results.concentrationPpm} ppm</span>
                                </div>
                            ` : ''}
                            ${results.breedingSitesEstimate ? `
                                <div class="flex justify-between">
                                    <span>Anggaran Tempat Pembiakan:</span>
                                    <span class="font-semibold">${results.breedingSitesEstimate} lokasi</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                // Equipment requirements (not for larvicide)
                if (results.applicationMethod !== 'larvicide') {
                    resultsHtml += `
                        <div class="bg-white p-4 rounded-lg mb-4">
                            <h3 class="font-semibold text-orange-800 mb-3">Keperluan Peralatan / Equipment Requirements</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span>Bilangan Caj / Number of Charges:</span>
                                    <span class="font-semibold">${results.chargesNeeded}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Caj per Mesin / Charges per Machine:</span>
                                    <span class="font-semibold">${results.chargesPerMachine}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Bilangan ${results.equipmentType}:</span>
                                    <span class="font-semibold">${results.equipmentNeeded}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // Safety warnings (common for both)
            if (results.safetyWarnings.length > 0) {
                resultsHtml += `
                    <div class="bg-red-50 border border-red-200 p-4 rounded-lg mb-4">
                        <h3 class="font-semibold text-red-800 mb-2 flex items-center gap-2">
                            <svg class="w-5 h-5" viewBox="0 0 24 24">
                                <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
                                <path d="M12 9v4m0 4h.01"/>
                            </svg>
                            Amaran Keselamatan / Safety Warnings
                        </h3>
                        <ul class="space-y-1 text-sm text-red-700">
                            ${results.safetyWarnings.map(warning => `
                                <li class="flex items-start gap-2">
                                    <span class="text-red-500 mt-1">•</span>
                                    <span>${warning}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }

            // Environmental warnings
            if (results.environmentalWarnings.length > 0) {
                resultsHtml += `
                    <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                        <h3 class="font-semibold text-yellow-800 mb-2 flex items-center gap-2">
                            <svg class="w-5 h-5" viewBox="0 0 24 24">
                                <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
                                <path d="M12 9v4m0 4h.01"/>
                            </svg>
                            Amaran Alam Sekitar / Environmental Warnings
                        </h3>
                        <ul class="space-y-1 text-sm text-yellow-700">
                            ${results.environmentalWarnings.map(warning => `
                                <li class="flex items-start gap-2">
                                    <span class="text-yellow-500 mt-1">•</span>
                                    <span>${warning}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }

            container.innerHTML = resultsHtml;
            container.style.display = 'block';
            noResults.style.display = 'none';
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Load custom products on page load
            loadCustomProducts();
            updateCalculationMode();
            updateProductInfo();

            // Product and mode selection changes
            document.getElementById('calculation_mode').addEventListener('change', updateCalculationMode);
            document.getElementById('insecticide_type').addEventListener('change', updateProductInfo);
            document.getElementById('application_method').addEventListener('change', updateProductInfo);
            document.getElementById('solvent_type').addEventListener('change', updateProductInfo);
            document.getElementById('location_type').addEventListener('change', updateProductInfo);

            // Button event listeners
            document.getElementById('btn-calculate').addEventListener('click', calculateDosage);
            document.getElementById('btn-reset').addEventListener('click', resetForm);
            
            document.getElementById('btn-add-product').addEventListener('click', function() {
                document.getElementById('add-product-modal').classList.add('show');
            });
            
            document.getElementById('btn-manage-products').addEventListener('click', function() {
                updateManageProductsList();
                document.getElementById('manage-products-modal').classList.add('show');
            });

            // Modal event listeners
            document.getElementById('btn-close-modal').addEventListener('click', closeAddProductModal);
            document.getElementById('btn-cancel-modal').addEventListener('click', closeAddProductModal);
            document.getElementById('btn-save-product').addEventListener('click', addCustomProduct);
            
            document.getElementById('btn-close-manage-modal').addEventListener('click', function() {
                document.getElementById('manage-products-modal').classList.remove('show');
            });

            // Close modals when clicking outside
            document.getElementById('add-product-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAddProductModal();
                }
            });
            
            document.getElementById('manage-products-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('show');
                }
            });
        });
    </script>
</body>
</html>
